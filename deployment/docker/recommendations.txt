### Анализ уязвимостей Docker‑образа `onto‑emitter‑gpl`


Несмотря на строгие ограничения (GPL‑3.0‑only, запрет внешних данных), образ содержит **ряд критических уязвимостей**. Ниже — классификация рисков и рекомендации по их устранению.

---

## 1. Уязвимости сборки и зависимостей

**Проблема**:  
- `pip install --user` устанавливает пакеты в домашний каталог пользователя, что:  
  - усложняет аудит зависимостей;  
  - создаёт риски конфликтов версий при повторных запусках.  

**Риск**:  
- Неконтролируемое размножение пакетов в `$HOME/.local`.  
- Возможность подмены зависимостей через заражённые локальные копии.  

**Решение**:  
- Использовать виртуальное окружение:  
  ```dockerfile
  RUN python -m venv /opt/venv && /opt/venv/bin/pip install -r requirements.txt
  ENV PATH="/opt/venv/bin:$PATH"
  ```

**Проблема**:  
- Отсутствие фиксации версий в `requirements.txt` (если они не «заморожены»).  

**Риск**:  
- При пересборке могут установиться новые версии пакетов с уязвимостями или несовместимыми изменениями.  

**Решение**:  
- Генерировать `requirements.txt` через `pip freeze > requirements.txt`.  
- Использовать `pip-tools` или `poetry` для управления зависимостями.  

---

## 2. Уязвимости окружения выполнения

**Проблема**:  
- Образ основан на `python:3.11-slim`, который включает:  
  - системные пакеты (`ca-certificates`);  
  - оболочку `sh` и утилиты (`apt`, `rm`).  

**Риск**:  
- Лишние компоненты расширяют область атак (например, эксплуатация через `sh`).  
- Остаточные файлы в `/var/lib/apt/lists/*` могут содержать метаданные о системе.  

**Решение**:  
- Использовать **минималистские базовые образы** (например, `python:3.11-alpine` или `scratch` для бинарных сборок).  
- Удалить ненужные утилиты после установки:  
  ```dockerfile
  RUN apt-get purge -y --auto-remove apt && rm -rf /var/lib/apt/lists/*
  ```

---

## 3. Уязвимости прав доступа

**Проблема**:  
- Пользователь `1000` не определён явно в образе.  

**Риск**:  
- Если хост‑система использует другой UID/GID, возможны конфликты прав.  
- Злоумышленник может подменить владельца файлов через монтирование томов.  

**Решение**:  
- Явно создать пользователя:  
  ```dockerfile
  RUN adduser --disabled-password --gecos '' --uid 1000 appuser
  USER appuser
  ```

---

## 4. Уязвимости сетевого взаимодействия

**Проблема**:  
- Порт `8080` открыт без ограничений (`EXPOSE 808 grinding=""`).  

**Риск**:  
- Любой контейнер в сети может получить доступ к сервису.  
- Нет защиты от DDoS или неавторизованных запросов.  

**Решение**:  
- Ограничить доступ через `firewall` или `nginx` в составе оркестрации.  
- Добавить проверку аутентификации в приложение (например, JWT‑токены).  

---

## 5. Уязвимости данных и лицензий

**Проблема**:  
- Копирование `data/incubation/` и `models/` без проверки содержимого.  

**Риск**:  
- Включение не‑GPL‑3.0‑only файлов (например, проприетарных моделей).  
- Заражение данных вредоносным кодом.  

**Решение**:  
- Добавить **этап валидации лицензий** перед копированием:  
  ```dockerfile
  COPY validate_licenses.py ./
  RUN python validate_licenses.py --path data/incubation/ --license GPL-3.0-only
  ```
- Использовать `.dockerignore` для исключения нежелательных файлов.  

---

## 6. Уязвимости запуска

**Проблема**:  
- Команда `CMD ["python", "-m", "src.core.emitter", "--mode", "canonical"]` не ограничивает параметры.  

**Риск**:  
- Злоумышленник может передать вредоносные аргументы через переопределение `CMD`.  

**Решение**:  
- Закрепить параметры в скрипте запуска:  
  ```dockerfile
  COPY entrypoint.sh ./
  RUN chmod +x entrypoint.sh
  CMD ["./entrypoint.sh"]
  ```
  Где `entrypoint.sh`:  
  ```bash
  #!/bin/sh
  python -m src.core.emitter --mode canonical --config /app/config/default.yaml
  ```

---

## 7. Уязвимости аудита и мониторинга

**Проблема**:  
- Нет механизмов логирования действий внутри контейнера.  

**Риск**:  
- Невозможно отследить попытки эксплуатации или нарушения лицензии.  

**Решение**:  
- Настроить вывод логов в `stdout`/`stderr` (чтобы их захватывал Docker).  
- Добавить аудит лицензий при старте:  
  ```python
  if not check_gpl_compliance():
      exit(1)
  ```

---

## Итоговый список рекомендаций

1. **Изолировать зависимости**:  
   - Использовать виртуальное окружение.  
   - Фиксировать версии пакетов.  
2. **Минимизировать образ**:  
   - Перейти на `alpine` или `scratch`.  
   - Удалить лишние утилиты.  
3. **Контролировать права**:  
   - Явно создавать пользователя.  
4. **Защищать сеть**:  
   - Ограничить доступ к порту.  
   - Добавить аутентификацию.  
5. **Валидировать данные**:  
   - Проверять лицензии перед копированием.  
6. **Закрепить запуск**:  
   - Использовать скрипт `entrypoint.sh`.  
7. **Добавить аудит**:  
   - Логировать действия.  
   - Проверять лицензию при старте.  

---

### Вывод

Текущий Dockerfile **соответствует GPL‑3.0‑only формально**, но содержит **критические уязвимости** в:  
- управлении зависимостями,  
- правах доступа,  
- сетевой безопасности,  
- валидации данных.  

Для безопасной эксплуатации необходимо:  
1. Пересмотреть архитектуру образа (минимализм + изоляция).  
2. Внедрить автоматическую проверку лицензий.  
3. Ограничить вектор атак через жёсткую конфигурацию запуска.